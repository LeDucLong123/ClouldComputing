# Cloud Computing

!["Ki·∫øn tr√∫c"](./so_do_kien_truc.png)

## Phase 1: L·∫≠p k·∫ø ho·∫°ch ki·∫øn tr√∫c v√† ∆∞·ªõc t√≠nh chi ph√≠

Pha ƒë·∫ßu ti√™n l√† b∆∞·ªõc quan tr·ªçng ƒë·ªÉ x√°c ƒë·ªãnh ki·∫øn tr√∫c t·ªïng th·ªÉ c·ªßa gi·∫£i ph√°p v√† ∆∞·ªõc t√≠nh chi ph√≠ tri·ªÉn khai tr√™n AWS. B·∫°n s·∫Ω thi·∫øt k·∫ø s∆° ƒë·ªì ki·∫øn tr√∫c, x√°c ƒë·ªãnh c√°c d·ªãch v·ª• c·∫ßn d√πng, v√† t√≠nh to√°n chi ph√≠ d·ª±a tr√™n th·ªùi gian s·ª≠ d·ª•ng trong 12 th√°ng t·∫°i v√πng `us-east-1`.

---

### üß© Task 1: Thi·∫øt k·∫ø s∆° ƒë·ªì ki·∫øn tr√∫c h·ªá th·ªëng

B·∫°n c·∫ßn v·∫Ω s∆° ƒë·ªì ki·∫øn tr√∫c minh h·ªça to√†n b·ªô gi·∫£i ph√°p, ƒë√°p ·ª©ng c√°c y√™u c·∫ßu t·ª´ ph√≠a ch·ªß qu√°n caf√©.

#### C√°c th√†nh ph·∫ßn b·∫Øt bu·ªôc trong s∆° ƒë·ªì:

- **Amazon CloudWatch log group**  
  Thu th·∫≠p log t·ª´ m√°y ch·ªß web (Apache).
- **CloudWatch Logs Insights**  
  Truy v·∫•n v√† ph√¢n t√≠ch d·ªØ li·ªáu log d·∫°ng clickstream.
- **CloudWatch Dashboard**  
  Tr·ª±c quan h√≥a d·ªØ li·ªáu log d∆∞·ªõi d·∫°ng bi·ªÉu ƒë·ªì.
- **AWS Cloud9** (EC2 instance)  
  Ch·∫°y web server v√† m√¥i tr∆∞·ªùng ph√°t tri·ªÉn/gi√°m s√°t.
- **IAM Role**  
  C·∫•p quy·ªÅn truy c·∫≠p c√°c d·ªãch v·ª• AWS t·ª´ EC2 instance.

- **Amazon S3**  
  L∆∞u tr·ªØ b·∫£n sao log ƒë·ªÉ truy v·∫•n b·∫±ng SQL ho·∫∑c s·ª≠ d·ª•ng c√¥ng c·ª• ph√¢n t√≠ch d·ªØ li·ªáu kh√°c.

#### T√πy ch·ªçn b·ªï sung:

- **Amazon Athena ho·∫∑c Amazon Redshift** _(n·∫øu mu·ªën truy v·∫•n log l∆∞u trong S3)_
- **Amazon VPC**: ki·∫øn tr√∫c m·∫°ng g·ªìm Public Subnet v√† Internet Gateway

#### C√¥ng c·ª• ƒë·ªÅ xu·∫•t ƒë·ªÉ v·∫Ω s∆° ƒë·ªì:

- [AWS Architecture Icons](https://aws.amazon.com/architecture/icons/)
- [AWS Reference Architecture Diagrams](https://aws.amazon.com/architecture/examples/)

> üéØ M·ª•c ti√™u: C√≥ m·ªôt s∆° ƒë·ªì ki·∫øn tr√∫c ho√†n ch·ªânh, d·ªÖ hi·ªÉu v√† tu√¢n theo chu·∫©n bi·ªÉu t∆∞·ª£ng AWS.

---

### üí∞ Task 2: ∆Ø·ªõc t√≠nh chi ph√≠ tri·ªÉn khai gi·∫£i ph√°p

S·ª≠ d·ª•ng **[AWS Pricing Calculator](https://calculator.aws.amazon.com/)** ƒë·ªÉ t√≠nh chi ph√≠ cho t·ª´ng d·ªãch v·ª• trong s∆° ƒë·ªì, gi·∫£ ƒë·ªãnh:

- **Region:** us-east-1
- **Th·ªùi gian s·ª≠ d·ª•ng:** 12 th√°ng
- **T·∫ßn su·∫•t s·ª≠ d·ª•ng:** d·ª±a tr√™n d·ªØ li·ªáu log gi·∫£ l·∫≠p trong lab

#### M·ªôt s·ªë th√†nh ph·∫ßn c·∫ßn ƒë∆∞a v√†o ∆∞·ªõc t√≠nh:

| D·ªãch v·ª• AWS           | Ghi ch√∫                                    |
| --------------------- | ------------------------------------------ |
| Amazon EC2 (t2.micro) | D√πng ch·∫°y Cloud9 v√† web server             |
| Amazon S3             | L∆∞u log clickstream (~10 GB ho·∫∑c h∆°n)      |
| Amazon CloudWatch     | Chi ph√≠ theo dung l∆∞·ª£ng log v√† s·ªë truy v·∫•n |
| IAM                   | Mi·ªÖn ph√≠                                   |
| AWS Data Transfer     | D·ªØ li·ªáu outbound n·∫øu c√≥                    |

> üìù Ghi l·∫°i to√†n b·ªô th√¥ng s·ªë c·∫•u h√¨nh v√† chi ph√≠ ∆∞·ªõc t√≠nh d∆∞·ªõi d·∫°ng PDF ho·∫∑c ch·ª•p m√†n h√¨nh ƒë·ªÉ ƒë∆∞a v√†o b√°o c√°o/presentation.

---

### üñºÔ∏è Tu·ª≥ ch·ªçn: Th√™m v√†o slide tr√¨nh b√†y

B·∫°n c√≥ th·ªÉ th√™m:

- S∆° ƒë·ªì ki·∫øn tr√∫c
- Chi ph√≠ ∆∞·ªõc t√≠nh
- Ghi ch√∫ gi·∫£i th√≠ch c√°c l·ª±a ch·ªçn thi·∫øt k·∫ø

N·∫øu c√≥ y√™u c·∫ßu t·ª´ gi·∫£ng vi√™n, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng template tr√¨nh chi·∫øu ƒë·ªÉ t·ªïng h·ª£p k·∫øt qu·∫£ t·ª´ng phase c·ªßa d·ª± √°n.

---

### ‚úÖ K·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c

- Thi·∫øt k·∫ø s∆° ƒë·ªì ki·∫øn tr√∫c ho√†n ch·ªânh cho gi·∫£i ph√°p ph√¢n t√≠ch clickstream.
- ∆Ø·ªõc t√≠nh chi ph√≠ tri·ªÉn khai trong 1 nƒÉm t·∫°i us-east-1.
- C√≥ th·ªÉ thuy·∫øt minh l√Ω do l·ª±a ch·ªçn d·ªãch v·ª• v√† gi·∫£i ph√°p thi·∫øt k·∫ø.

## Phase 2: Ph√¢n t√≠ch website v√† x√°c nh·∫≠n d·ªØ li·ªáu weblog

Trong pha n√†y, b·∫°n s·∫Ω:

- Ph√¢n t√≠ch h·∫° t·∫ßng ƒë√£ ƒë∆∞·ª£c t·∫°o s·∫µn tr√™n AWS.
- Ki·ªÉm tra kh·∫£ nƒÉng truy c·∫≠p website qu√°n caf√©.
- Quan s√°t c√°ch d·ªØ li·ªáu clickstream (log truy c·∫≠p) ƒë∆∞·ª£c ghi l·∫°i.

---

### ‚úÖ Task 1: Ph√¢n t√≠ch m√¥i tr∆∞·ªùng lab

Khi kh·ªüi ƒë·ªông m√¥i tr∆∞·ªùng lab, c√°c t√†i nguy√™n sau ƒë∆∞·ª£c t·∫°o s·∫µn:

- **VPC (Virtual Private Cloud)** t√™n l√† `Lab VPC` v·ªõi m·ªôt public subnet.
- **AWS Cloud9** IDE ch·∫°y tr√™n **EC2 instance** trong subnet ƒë√≥.
- **Security Group** g·∫Øn v·ªõi EC2 ƒë·ªÉ ki·ªÉm so√°t truy c·∫≠p.
- **IAM Role: `CafeRole`** c·∫•p quy·ªÅn cho EC2 truy c·∫≠p c√°c d·ªãch v·ª• AWS (S3, CloudWatch...).
- EC2 instance ƒë·ªìng th·ªùi ch·∫°y:
  - Web server Apache (`httpd`) ch·∫°y ·ª©ng d·ª•ng qu√°n caf√© vi·∫øt b·∫±ng PHP.
  - C∆° s·ªü d·ªØ li·ªáu MariaDB.

> ‚ö†Ô∏è L∆∞u √Ω:
>
> - Khi lab k·∫øt th√∫c, EC2 instance s·∫Ω b·ªã **stop**.
> - B·∫°n c·∫ßn **kh·ªüi ƒë·ªông l·∫°i instance** n·∫øu quay l·∫°i lab v√†o ng√†y kh√°c.
> - C√≥ th·ªÉ **reset lab** ƒë·ªÉ x√≥a s·∫°ch v√† kh·ªüi t·∫°o l·∫°i t·ª´ ƒë·∫ßu.

---

### üåê Task 2: Cho ph√©p truy c·∫≠p v√† ki·ªÉm tra website

Website ch·∫°y tr√™n **port 80**, nh∆∞ng m·∫∑c ƒë·ªãnh **Security Group kh√¥ng m·ªü c·ªïng** n√†y. Ta c·∫ßn:

1. M·ªü EC2 console, ch·ªçn instance.
2. V√†o tab **Security ‚Üí Security Groups** ‚Üí ch·ªçn nh√≥m ƒëang g·∫Øn v·ªõi EC2.
3. Th√™m rule m·ªõi:

   - Type: `HTTP`
   - Port: `80`
   - Source: `Anywhere - IPv4 (0.0.0.0/0)`

4. Copy **Public IPv4** c·ªßa instance.
5. M·ªü tr√¨nh duy·ªát v√† truy c·∫≠p:
   ```http
   http://<public-ip>/cafe
   ```

### üìú Task 3: Theo d√µi v√† sao l∆∞u log truy c·∫≠p

#### Apache l∆∞u log t·∫°i:

```bash
/var/log/httpd/access_log
```

#### ƒê·ªÉ quan s√°t log khi ng∆∞·ªùi d√πng truy c·∫≠p website:

1. M·ªü Cloud9 IDE terminal.
2. Ch·∫°y l·ªánh:

```bash
tail -f /var/log/httpd/access_log
```

#### Sao l∆∞u log g·ªëc:

```bash
sudo cp /var/log/httpd/access_log /home/ec2-user/environment/initial_access_log
```

## Phase 3: C√†i ƒë·∫∑t v√† c·∫•u h√¨nh CloudWatch Agent ƒë·ªÉ thu th·∫≠p log Apache

Trong pha n√†y, b·∫°n s·∫Ω c√†i ƒë·∫∑t v√† c·∫•u h√¨nh CloudWatch Agent tr√™n m√°y ch·ªß web ƒë·ªÉ g·ª≠i c√°c log truy c·∫≠p (`access_log`) v√† l·ªói (`error_log`) t·ª´ m√°y ch·ªß Apache l√™n Amazon CloudWatch.

### 1. C√†i ƒë·∫∑t CloudWatch Agent

Th·ª±c hi·ªán l·ªánh sau tr√™n EC2:

```bash
sudo yum install -y amazon-cloudwatch-agent
```

C√¥ng c·ª• n√†y gi√∫p g·ª≠i log t·ª´ EC2 l√™n d·ªãch v·ª• CloudWatch Logs.

---

### 2. T·∫£i v√† c·∫•u h√¨nh file `config.json`

T·∫£i file c·∫•u h√¨nh m·∫´u t·ª´ AWS S3 v√† di chuy·ªÉn v√†o th∆∞ m·ª•c CloudWatch Agent:

```bash
wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACCAP4-1-91575/capstone-4-clickstream/s3/config.json
sudo mv config.json /opt/aws/amazon-cloudwatch-agent/bin/
```

Xem n·ªôi dung:

```bash
sudo cat /opt/aws/amazon-cloudwatch-agent/bin/config.json
```

> File `config.json` ƒë·ªãnh nghƒ©a:
>
> - Ngu·ªìn log (`access_log`, `error_log`).
> - Log group trong CloudWatch.
> - Th·ªùi gian gi·ªØ log.
> - Metrics c·∫ßn thu th·∫≠p.

---

### 3. Chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng log Apache sang JSON

CloudWatch Agent ho·∫°t ƒë·ªông hi·ªáu qu·∫£ h∆°n v·ªõi log d·∫°ng JSON, v√¨ v·∫≠y b·∫°n c·∫ßn ch·ªânh Apache ƒë·ªÉ log theo ƒë·ªãnh d·∫°ng n√†y.

#### a. Chu·∫©n b·ªã ch·ªânh s·ª≠a:

T·∫°o symlink ƒë·ªÉ hi·ªÉn th·ªã file d·ªÖ h∆°n tr√™n Cloud9:

```bash
ln -s /etc/httpd/conf /home/ec2-user/environment/httpdconf
```

C·∫•p quy·ªÅn ch·ªânh s·ª≠a file:

```bash
sudo chown -R ec2-user /etc/httpd/conf
```

#### b. Ch·ªânh s·ª≠a file `httpd.conf`

M·ªü file `httpd.conf` v√† th·ª±c hi·ªán:

**S·ª≠a log l·ªói (error log):**

T√¨m d√≤ng:

```apache
ErrorLog "logs/error_log"
```

Comment l·∫°i v√† th√™m sau ƒë√≥:

```apache
# ErrorLog "logs/error_log"
ErrorLog "/var/log/www/error/error_log"
ErrorLogFormat "{\"time\":\"%{%usec_frac}t\", \"function\" : \"[%-m:%l]\", \"process\" : \"[pid%P]\" ,\"message\" : \"%M\"}"
```

**S·ª≠a log truy c·∫≠p (access log):**

T√¨m kh·ªëi `<IfModule log_config_module>`, comment d√≤ng `LogFormat ... combined`. Sau d√≤ng `LogFormat ... common`, th√™m:

```apache
LogFormat "{ \"time\":\"%{%Y-%m-%d}tT%{%T}t.%{msec_frac}tZ\", \"process\":\"%D\", \"filename\":\"%f\", \"remoteIP\":\"%a\", \"host\":\"%V\", \"request\":\"%U\", \"query\":\"%q\",\"method\":\"%m\", \"status\":\"%>s\", \"userAgent\":\"%{User-agent}i\",\"referer\":\"%{Referer}i\"}" cloudwatch
```

T√¨m d√≤ng:

```apache
CustomLog "logs/access_log" combined
```

Gi·ªØ nguy√™n, sau ƒë√≥ th√™m d√≤ng m·ªõi:

```apache
CustomLog "/var/log/www/access/access_log" cloudwatch
```

N·∫øu c√≥ kh·ªëi `<IfModule logio_module>`, comment to√†n b·ªô 3 d√≤ng ch∆∞a ƒë∆∞·ª£c comment.

L∆∞u l·∫°i file `httpd.conf`.

---

### 4. T·∫°o th∆∞ m·ª•c log v√† kh·ªüi ƒë·ªông l·∫°i d·ªãch v·ª•

T·∫°o th∆∞ m·ª•c log:

```bash
sudo mkdir -p /var/log/www/access
sudo mkdir -p /var/log/www/error
```

Kh·ªüi ƒë·ªông l·∫°i Apache:

```bash
sudo systemctl restart httpd
```

Kh·ªüi ƒë·ªông CloudWatch Agent:

```bash
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config \
  -m ec2 \
  -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json \
  -s
```

Ki·ªÉm tra tr·∫°ng th√°i Agent:

```bash
service amazon-cloudwatch-agent status
```

> N·∫øu hi·ªÉn th·ªã `active (running)` l√† b·∫°n ƒë√£ c√†i ƒë·∫∑t th√†nh c√¥ng.

## Phase 4: Ki·ªÉm tra CloudWatch Agent v√† log clickstream

### 1. Ki·ªÉm tra file access_log

Truy c·∫≠p ·ª©ng d·ª•ng web caf√© v√† th·ª±c hi·ªán m·ªôt s·ªë h√†nh ƒë·ªông nh∆∞ xem menu, ƒë·∫∑t h√†ng ƒë·ªÉ t·∫°o log.

D√πng l·∫°i l·ªánh nh∆∞ Phase 2 Task 3 ƒë·ªÉ xem n·ªôi dung ƒë∆∞·ª£c ghi v√†o file log truy c·∫≠p:

```bash
tail -f /var/log/www/access/access_log
```

> L∆∞u √Ω: log gi·ªù ƒë√¢y s·∫Ω ƒë∆∞·ª£c ghi d∆∞·ªõi ƒë·ªãnh d·∫°ng JSON.

---

### 2. Ki·ªÉm tra file `amazon-cloudwatch-agent.log`

X√°c ƒë·ªãnh v·ªã tr√≠ file log c·ªßa agent:

```bash
sudo cat /opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log
```

Ki·ªÉm tra c√≥ c√°c d√≤ng nh∆∞ sau kh√¥ng:

```text
[inputs.logfile] Reading from offset 10620 in /var/log/www/error/error_log
[inputs.logfile] Reading from offset 19850 in /var/log/www/access/access_log
[logagent] piping log from apache/error/i-<instance-id> to cloudwatchlogs
[logagent] piping log from apache/access/i-<instance-id> to cloudwatchlogs
```

> Nh·ªØng d√≤ng n√†y x√°c nh·∫≠n r·∫±ng agent ƒëang ƒë·ªçc log v√† g·ª≠i l√™n CloudWatch. B·ªè qua c√°c l·ªói nh∆∞ `permission denied` tr√™n `/sys/kernel/debug/tracing`.

---

### 3. ƒê·∫∑t h√†ng v√† ki·ªÉm tra log tr√™n CloudWatch

- Truy c·∫≠p website: `http://<public-ip>/cafe`
- V√†o trang Menu, ƒë·∫∑t m·ªôt ƒë∆°n h√†ng (s·ª≠ d·ª•ng thi·∫øt b·ªã di ƒë·ªông n·∫øu mu·ªën thay ƒë·ªïi User-Agent).

Ki·ªÉm tra log:

- M·ªü AWS CloudWatch Console.
- V√†o **Log Groups** ‚Üí `apache/access`
- M·ªü log stream t∆∞∆°ng ·ª©ng.
- M·ªü r·ªông d√≤ng log ƒë·∫ßu ti√™n, x√°c minh h√†nh ƒë·ªông v·ª´a th·ª±c hi·ªán c√≥ ƒë∆∞·ª£c ghi nh·∫≠n (d·∫°ng JSON).

> Clickstream data hi·ªán ƒë√£ ƒë∆∞·ª£c thu th·∫≠p v√† l∆∞u tr√™n CloudWatch Logs th√¥ng qua CloudWatch Agent ch·∫°y tr√™n web server.

## Phase 5: S·ª≠ d·ª•ng log gi·∫£ l·∫≠p v√† x√°c minh CloudWatch nh·∫≠n ƒë·ªß d·ªØ li·ªáu

Trong pha n√†y, b·∫°n s·∫Ω thay th·∫ø file `access_log` hi·ªán t·∫°i b·∫±ng m·ªôt file log gi·∫£ l·∫≠p c√≥ s·∫µn. File n√†y ch·ª©a nhi·ªÅu d√≤ng log truy c·∫≠p h∆°n nhi·ªÅu so v·ªõi vi·ªác b·∫°n t·ª± tay truy c·∫≠p website. Nh·ªù ƒë√≥ b·∫°n c√≥ th·ªÉ ki·ªÉm tra kh·∫£ nƒÉng x·ª≠ l√Ω log ·ªü quy m√¥ l·ªõn c·ªßa CloudWatch Agent.

### 1. Ph√¢n t√≠ch file log gi·∫£ l·∫≠p

Xem v√†i d√≤ng ƒë·∫ßu c·ªßa file log m·∫´u:

```bash
cat samplelogs/access_log.log | head
```

Xem d√≤ng ƒë·∫ßu d∆∞·ªõi d·∫°ng JSON d·ªÖ ƒë·ªçc:

```bash
cat samplelogs/access_log.log | head -1 | python -m json.tool
```

ƒê·∫øm s·ªë d√≤ng log trong file:

```bash
cat samplelogs/access_log.log | wc -l
```

> B·∫°n s·∫Ω th·∫•y file n√†y c√≥ r·∫•t nhi·ªÅu log m√¥ ph·ªèng ng∆∞·ªùi d√πng th·ª±c.

---

### 2. Thay th·∫ø file log th·ª±c b·∫±ng file log gi·∫£ l·∫≠p

D·ª´ng CloudWatch Agent:

```bash
sudo systemctl stop amazon-cloudwatch-agent
```

ƒê·∫∑t file gi·∫£ l·∫≠p v√†o ƒë√∫ng v·ªã tr√≠ CloudWatch Agent ƒë·ªçc log:

```bash
sudo cp samplelogs/access_log.log /var/log/www/access/access_log
```

> **L∆∞u √Ω:** T√™n file ph·∫£i l√† `access_log`, kh√¥ng ph·∫£i `access_log.log`

Kh·ªüi ƒë·ªông l·∫°i CloudWatch Agent:

```bash
sudo systemctl start amazon-cloudwatch-agent
```

---

### 3. Ki·ªÉm tra log gi·∫£ l·∫≠p tr√™n CloudWatch

- M·ªü AWS CloudWatch Console
- V√†o **Log Groups** ‚Üí `apache/access`
- M·ªü log stream t∆∞∆°ng ·ª©ng
- X√°c nh·∫≠n:
  - C√≥ **nhi·ªÅu d√≤ng log** xu·∫•t hi·ªán
  - C√≥ th·ªÉ c√≥ **nhi·ªÅu d√≤ng c√πng m·ªôt timestamp** (do agent ƒë·ªçc nhanh file log l·ªõn)

> Nh∆∞ v·∫≠y b·∫°n ƒë√£ x√°c minh th√†nh c√¥ng r·∫±ng log truy c·∫≠p gi·∫£ l·∫≠p ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫ßy ƒë·ªß l√™n CloudWatch Logs.

# Phase 6: Ph√¢n t√≠ch d·ªØ li·ªáu clickstream v·ªõi CloudWatch Logs Insights

Trong pha n√†y, b·∫°n s·∫Ω s·ª≠ d·ª•ng **CloudWatch Logs Insights** ƒë·ªÉ truy v·∫•n d·ªØ li·ªáu log truy c·∫≠p (`access_log`) ƒë√£ ƒë∆∞·ª£c g·ª≠i l√™n CloudWatch t·ª´ m√°y ch·ªß Apache. M·ª•c ti√™u l√† x√°c ƒë·ªãnh:

- C√≥ bao nhi√™u ng∆∞·ªùi truy c·∫≠p v√†o trang menu
- Bao nhi√™u ng∆∞·ªùi trong s·ªë ƒë√≥ ƒë√£ ƒë·∫∑t h√†ng
- Bao nhi√™u ng∆∞·ªùi v√†o menu m√† kh√¥ng mua g√¨

---

### 1. Truy v·∫•n s·ªë ng∆∞·ªùi ƒë√£ v√†o trang menu

M·ªü **CloudWatch Console** > **Logs Insights**

Ch·∫°y c√¢u truy v·∫•n sau ƒë·ªÉ ƒë·∫øm s·ªë l∆∞·ª£t truy c·∫≠p v√†o `/cafe/menu.php`:

```sql
fields @timestamp, remoteIP
| filter request = "/cafe/menu.php"
| stats count(remoteIP) as Visitors by @timestamp
| sort @timestamp asc
```

- üìù Ghi l·∫°i k·∫øt qu·∫£ v√†o phase6-results.txt.
- L∆∞u truy v·∫•n v·ªõi t√™n: menu-visitors trong folder non-geo-results.

### 2. Truy v·∫•n s·ªë ng∆∞·ªùi ƒë√£ ƒë·∫∑t h√†ng

**Ti·∫øp t·ª•c v·ªõi Logs Insights, ch·∫°y truy v·∫•n sau:**

```sql
fields @timestamp, remoteIP
| filter request = "/cafe/processOrder.php"
| stats count(remoteIP) as Purchasers by @timestamp
| sort @timestamp asc
```

- üìù Ghi l·∫°i k·∫øt qu·∫£ v√†o phase6-results.txt.
- L∆∞u truy v·∫•n v·ªõi t√™n: purchasers trong folder non-geo-results.

## Phase 7: ƒêi·ªÅu ch·ªânh pipeline ƒë·ªÉ cung c·∫•p th√¥ng tin ph√¢n t√≠ch m·ªõi

Trong pha n√†y, b·∫°n s·∫Ω n√¢ng c·∫•p h·ªá th·ªëng log hi·ªán t·∫°i ƒë·ªÉ cung c·∫•p th√™m th√¥ng tin **ƒë·ªãa l√Ω** v√† t·∫°o **b·∫£ng ƒëi·ªÅu khi·ªÉn tr·ª±c quan (dashboard)** cho ch·ªß qu√°n caf√©. Ngo√†i ra, b·∫°n c≈©ng s·∫Ω l∆∞u tr·ªØ log v√†o Amazon S3 ƒë·ªÉ c√≥ th·ªÉ ph√¢n t√≠ch sau b·∫±ng SQL.

---

### üéØ M·ª•c ti√™u ch√≠nh

- Th√™m th√¥ng tin v·ªã tr√≠ ƒë·ªãa l√Ω (geolocation) v√†o d·ªØ li·ªáu clickstream.
- T·∫°o dashboard hi·ªÉn th·ªã:
  - Bi·ªÉu ƒë·ªì th√†nh ph·ªë c√≥ nhi·ªÅu ng∆∞·ªùi truy c·∫≠p menu nh·∫•t.
  - B·∫£ng th√†nh ph·ªë c√≥ nhi·ªÅu ng∆∞·ªùi ƒë·∫∑t h√†ng nh·∫•t.
  - Bi·ªÉu ƒë·ªì v√πng c√≥ nhi·ªÅu ng∆∞·ªùi truy c·∫≠p trang ch√≠nh nh·∫•t.
  - Bi·ªÉu ƒë·ªì c·ªôt v√πng c√≥ nhi·ªÅu ng∆∞·ªùi ƒë·∫∑t h√†ng nh·∫•t.
- L∆∞u tr·ªØ log v√†o Amazon S3 v√† c√≥ th·ªÉ truy v·∫•n b·∫±ng SQL.

---

### üß™ Task 1: Hi·ªÉu y√™u c·∫ßu m·ªõi t·ª´ ch·ªß qu√°n

Ch·ªß qu√°n caf√© mu·ªën bi·∫øt:

- Kh√°ch truy c·∫≠p ƒë·∫øn t·ª´ th√†nh ph·ªë/v√πng n√†o nhi·ªÅu nh·∫•t.
- N∆°i n√†o c√≥ nhi·ªÅu ng∆∞·ªùi ƒë·∫∑t h√†ng nh·∫•t.
- Xem ƒë∆∞·ª£c th√¥ng tin n√†y d∆∞·ªõi d·∫°ng bi·ªÉu ƒë·ªì tr·ª±c quan.
- Log c·∫ßn ƒë∆∞·ª£c l∆∞u tr·ªØ v√†o S3 ƒë·ªÉ ph√¢n t√≠ch linh ho·∫°t h∆°n trong t∆∞∆°ng lai.

---

### üì¶ Task 2: D√πng file log c√≥ geolocation

#### B∆∞·ªõc 1: Ki·ªÉm tra log m·∫´u

```bash
cd ~/environment
head -1 samplelogs/access_log_geo.log | python -m json.tool
cat samplelogs/access_log_geo.log | wc -l
```

##### D·ªØ li·ªáu m·∫´u c√≥ ch·ª©a:

```json
"city": "La Rinconada",
"region": "Andalusia",
"country": "ES",
"lat": "37.48",
"lon": "-5.98"
```

#### B∆∞·ªõc 2: Thay th·∫ø file log hi·ªán t·∫°i

```bash
sudo systemctl stop amazon-cloudwatch-agent
sudo cp samplelogs/access_log_geo.log /var/log/www/access/access_log
sudo head -1 /var/log/www/access/access_log
```

#### B∆∞·ªõc 3: X√≥a log stream c≈©

V√†o AWS Console ‚Üí CloudWatch Logs ‚Üí Log group apache/access ‚Üí ch·ªçn log stream c≈© v√† Delete.

#### B∆∞·ªõc 4: Kh·ªüi ƒë·ªông l·∫°i agent

```bash
sudo systemctl start amazon-cloudwatch-agent
```

### üìä Task 3: T·∫°o Dashboard

#### Widget 1: Pie Chart ‚Äì Th√†nh ph·ªë c√≥ nhi·ªÅu ng∆∞·ªùi truy c·∫≠p menu nh·∫•t

- Widget name: Cities visiting the menu the most
- Type: Pie
- Query:

```bash
fields remoteIP, city
| filter request = "/cafe/menu.php"
| stats count() as menupopular by city
| sort menupopular desc
| limit 10
```

#### Widget 2: Table ‚Äì Th√†nh ph·ªë ƒë·∫∑t h√†ng nhi·ªÅu nh·∫•t

- Widget name: Cities placing the most orders
- Type: Logs Table
- Query:

```bash
fields city
| filter request = "/cafe/processOrder.php"
| stats count() as orders by city
| sort orders desc
| limit 10
```

#### Widget 3: Pie Chart ‚Äì V√πng truy c·∫≠p trang ch√≠nh nhi·ªÅu nh·∫•t

- Widget name: Regions visiting the website the most
- Type: Pie
- Query:

```bash
fields region
| filter request = "/cafe"
| stats count() as visits by region
| sort visits desc
| limit 10
```

#### Widget 4: Bar Chart ‚Äì V√πng c√≥ nhi·ªÅu ƒë∆°n h√†ng nh·∫•t

- Widget name: Regions placing the most orders
- Type: Bar
- Query:

```bash
fields region
| filter request = "/cafe/processOrder.php"
| stats count() as purchases by region
| sort purchases desc
| limit 10
```

### ‚òÅÔ∏è Task 4: L∆∞u log v√†o Amazon S3

#### B∆∞·ªõc 1: Ki·ªÉm tra t√™n bucket

```bash
aws s3 ls
```

##### V√≠ d·ª• k·∫øt qu·∫£:

```bash
2025-06-13 15:40:15 accap4-logsbucket--af31f500
```

#### B∆∞·ªõc 2: L∆∞u file log l√™n S3

```bash
aws s3 cp /var/log/www/access/access_log s3://accap4-logsbucket--af31f500/
```
